<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Arbeitsdienst eintragen</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
input, textarea, button { display:block; margin: 10px 0; padding:5px; width: 100%; max-width:400px; }
#tasksList, #myHours { margin-top: 20px; }
.task { border:1px solid #ccc; padding:10px; margin-bottom:10px; }
</style>
</head>
<body>

<h1>Arbeitsdienste Vereinsverwaltung - 0.5</h1>

<div id="auth">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="E-Mail">
  <input type="password" id="password" placeholder="Passwort">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Registrieren</button>
  <div id="authMessage"></div>
</div>

<div id="userArea" style="display:none;">
  <h2>Willkommen, <span id="userEmail"></span></h2>
  <button id="logoutBtn">Logout</button>

  <h3>Arbeitsdienst eintragen</h3>
  <input type="date" id="workDate">
  <input type="number" step="0.25" id="workHours" placeholder="Stunden">
  <textarea id="workDesc" placeholder="Beschreibung"></textarea>
  <button id="saveWorkBtn">Speichern</button>

  <div id="myHours">
    <h3>Meine Einträge</h3>
    <ul id="hoursList"></ul>
  </div>

  <div id="tasks">
    <h3>Arbeitsdienste Übersicht</h3>
    <ul id="tasks"></ul>
  </div>
</div>

<script type="module">
  
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const supabaseUrl = 'https://hteeyyfsaotcavvtvizt.supabase.co'
  const supabaseKey = "sb_publishable_pm6p0UM8_GARF3TIY51Heg_Sk3tacHJ";
  const supabase = createClient(supabaseUrl, supabaseKey)

  console.log("Supabase Client geladen:", supabase);
  
  // Supabase initialisieren
  //const supabaseUrl = "https://hteeyyfsaotcavvtvizt.supabase.co"; // <--- DEIN URL
  //const supabaseAnonKey = "sb_publishable_pm6p0UM8_GARF3TIY51Heg_Sk3tacHJ";         // <--- DEIN ANON KEY
  //const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  const authDiv = document.getElementById("auth");
  const userArea = document.getElementById("userArea");
  const userEmailSpan = document.getElementById("userEmail");
  const authMessage = document.getElementById("authMessage");

  // Login
  //document.getElementById("loginBtn").addEventListener("click", async () => {
  //  const email = document.getElementById("email").value;
  //  const password = document.getElementById("password").value;
  //  try {
  //    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  //    console.log("Suprabase login data:", data);
  //    console.log("Supabase login error:", error);
      
  //   if(error) { authMessage.textContent = "Fehler: " + error.message;
  //    } else { initUserArea(data.user);} 
  //  } catch (err) {
  //    console.error("Unerwarteter Fehler:", err);
  //  }
  //});

  //Login

  // Login
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
      // Login versuchen
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      console.log("Supabase login data:", data);
      console.log("Supabase login error:", error);

      if (error) {
        authMessage.textContent = "Fehler: " + error.message;
        return;
      }

      // User korrekt aus der Session holen
      const user = data.user ?? data.session?.user;

      if (!user) {
        authMessage.textContent = "Login fehlgeschlagen: kein User gefunden.";
        return;
      }

      // User-Bereich initialisieren
      initUserArea(user);

    } catch (err) {
      console.error("Unerwarteter Fehler:", err);
      authMessage.textContent = "Unerwarteter Fehler. Siehe Konsole.";
    }
  });

  // Registrierung
  //document.getElementById("signupBtn").addEventListener("click", async () => {
  //  const email = document.getElementById("email").value;
  //  const password = document.getElementById("password").value;
  //  const { data, error } = await supabase.auth.signUp({ email, password });
  //  if(error) { authMessage.textContent = "Fehler: " + error.message; }
  //  else { authMessage.textContent = "Registrierung erfolgreich! Bitte E-Mail bestätigen."; }
  //});

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    authDiv.style.display = "block";
    userArea.style.display = "none";
    authMessage.textContent = "";
  });

  // Benutzerbereich initialisieren
  function initUserArea(user) {
    authDiv.style.display = "none";
    userArea.style.display = "block";
    userEmailSpan.textContent = user.email;
    loadMyHours();
    loadTasks();
  }
  
  //---------------------------------------------------------------------------
  //Arbeitsdienst eintragen (Stunden speichern)
  //---------------------------------------------------------------------------
  
  document.getElementById("saveWorkBtn").addEventListener("click", async () => {
  const date = document.getElementById("workDate").value;
  const hours = parseFloat(document.getElementById("workHours").value);
  const desc = document.getElementById("workDesc").value;

  try {
    // Aktuellen User holen
    const { data: userData, error: userError } = await supabase.auth.getUser();

    if (userError) {
      alert("Fehler beim Abrufen des Users: " + userError.message);
      return;
    }

    if (!userData?.user) {
      alert("Kein eingeloggter User gefunden. Bitte einloggen.");
      return;
    }

    // Arbeitsstunden speichern
    const { error } = await supabase.from("work_hours").insert([{
      user_id: userData.user.id,
      date,
      hours,
      description: desc
    }]);

    if (error) {
      alert("Fehler: " + error.message);
    } else {
      loadMyHours(); // Optional: Stunden neu laden
    }

  } catch (err) {
    console.error("Unerwarteter Fehler beim Speichern:", err);
    alert("Unerwarteter Fehler. Siehe Konsole.");
  }
  });

  //----------------------------------------------------------------------------
  // Eigene Stunden laden
  //----------------------------------------------------------------------------
  async function loadMyHours() {
    const { data, error } = await supabase.from("work_hours")
      .select("*")
      .order("date", { ascending: false });
    const list = document.getElementById("hoursList");
    list.innerHTML = "";
    if(data) {
      data.forEach(h => {
        const li = document.createElement("li");
        li.textContent = `${h.date}: ${h.hours} Stunden - ${h.description}`;
        list.appendChild(li);
      });
    }
  }

  //-----------------------------------------------------------------------------------
  // Prüfen, ob User schon eingeloggt
  //-----------------------------------------------------------------------------------
  supabase.auth.onAuthStateChange((event, session) => {
    if(session && session.user) { initUserArea(session.user); }
  });

  //-----------------------------------------------------------------------------------
  // Funktion, um die verfügbaren Arbeitsdienste zu laden
  //-----------------------------------------------------------------------------------
  async function loadTasks() {
  const tasksDiv = document.getElementById("tasks");
  tasksDiv.innerHTML = "Lade Arbeitsdienste...";

  const { data: tasks, error } = await supabase
    .from("work_tasks")
    .select(`
      id,
      title,
      start_time,
      max_helpers,
      work_task_signups (
        id,
        profiles (
          full_name
        )
      )
    `)
    .order("start_time", { ascending: true });

    
  //const { data: tasks, error } = await supabase
  //  .from("work_tasks")
  //  .select(`
  //    id,
  //    title,
  //    start_time,
  //    max_helpers,
  //    work_task_signups(count)
  //  `)
  //  .order("start_time", { ascending: true });

  if (error) {
    tasksDiv.textContent = error.message;
    return;
  }

  tasksDiv.innerHTML = "";

  tasks.forEach(task => {
    const used = task.work_task_signups[0].count;
    const free = task.max_helpers - used;

    const helpersList = task.work_task_signups
    .map(s => s.profiles?.full_name)
    .filter(Boolean)
    .map(name => `<li>${name}</li>`)
    .join("");


    tasksDiv.innerHTML += `
      <div class="task">
      <h3>${task.title}</h3>
      <p>${new Date(task.start_time).toLocaleString("de-DE")}</p>
      <p>Helfer: ${used} / ${task.max_helpers}</p>

      ${
        helpersList
          ? `<p><strong>Angemeldet:</strong></p><ul>${helpersList}</ul>`
          : `<p><em>Noch keine Anmeldungen</em></p>`
      }

      ${
        free > 0
          ? `<button onclick="signup('${task.id}')">Eintragen</button>`
          : `<strong>Ausgebucht</strong>`
        }
      </div>
    `;
  });
}

//-----------------------------------------------------------------

  
  
</script>
</body>
</html>


